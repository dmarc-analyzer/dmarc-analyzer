# DMARC 分析器

DMARC 分析器是一个用于处理和分析 DMARC（基于域的消息认证、报告和一致性）报告的工具。它帮助组织监控电子邮件认证结果，保护其域名免受电子邮件欺骗和钓鱼攻击。

## 目录

- [概述](#概述)
- [前提条件](#前提条件)
- [环境变量](#环境变量)
- [开发环境设置](#开发环境设置)
- [AWS 服务配置](#aws-服务配置)
- [API 文档](#api-文档)
- [部署](#部署)

## 概述

DMARC 分析器处理存储在 S3 存储桶中的 DMARC 聚合报告。它解析这些报告，提取相关信息，并将数据存储在 PostgreSQL 数据库中以进行分析和可视化。

## 前提条件

- Go 1.18 或更高版本
- PostgreSQL 14 或更高版本
- 具有 S3 访问权限的 AWS 账户
- Docker 和 Docker Compose（用于容器化部署）

## 环境变量

应用程序需要以下环境变量：

```
# 数据库配置
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/dmarcdb

# AWS 配置
S3_BUCKET_NAME=your-dmarc-reports-bucket
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=your-aws-region
```

## 开发环境设置

### 1. 克隆仓库

```sh
git clone https://github.com/dmarc-analyzer/dmarc-analyzer.git
cd dmarc-analyzer
```

### 2. 设置数据库

```sh
# 创建 PostgreSQL 数据库
createdb dmarcdb

# 应用现有架构到您的数据库
psql -d dmarcdb -f backend/schema.sql
```

### 3. 重新生成数据库架构（高级）

此步骤仅在您修改了模型类并需要重新生成schema.sql文件时才需要执行。

```sh
# 生成新的数据库架构
dropdb --if-exists gen_sql && createdb gen_sql
go run ./backend/cmd/generate_sql.go
echo '-- Code generated by dmarc-analyzer generate_sql. DO NOT EDIT.' > backend/schema.sql
pg_dump -d gen_sql --schema-only --no-owner | sed '/^--/d' | sed '/^SET /d' | sed '/^SELECT /d' | sed 's/public\.//g' | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' -e 's/\n\n*/\n/' >> backend/schema.sql
dropdb --if-exists gen_sql

# 将新生成的架构应用到您的数据库
psql -d dmarcdb -f backend/schema.sql
```

### 4. 配置环境变量

在项目根目录中创建一个 `.env` 文件，其中包含上面列出的必需环境变量。

### 5. 运行应用程序

```sh
# 启动服务器
go run ./backend/cmd/server/server.go
```

服务器默认将在端口 6767 上启动。

## AWS 服务配置

### S3 存储桶设置

1. 创建一个 S3 存储桶来存储 DMARC 报告：
   - 登录 AWS 管理控制台
   - 导航到 S3 服务
   - 点击"创建存储桶"
   - 输入唯一的存储桶名称
   - 根据需要配置存储桶设置
   - 点击"创建存储桶"

2. 配置 IAM 权限：
   - 创建具有以下权限的 IAM 用户或角色：
     ```json
     {
       "Version": "2012-10-17",
       "Statement": [
         {
           "Effect": "Allow",
           "Action": [
             "s3:GetObject",
             "s3:ListBucket"
           ],
           "Resource": [
             "arn:aws:s3:::your-dmarc-reports-bucket",
             "arn:aws:s3:::your-dmarc-reports-bucket/*"
           ]
         }
       ]
     }
     ```

3. 获取 IAM 用户的 AWS 凭证（访问密钥 ID 和秘密访问密钥）。

### 接收 DMARC 报告

要在 S3 存储桶中接收 DMARC 报告，您需要：

1. 为您的域名设置 DMARC 记录，并指定适当的报告地址
2. 配置 AWS SES 接收电子邮件并将其存储在您的 S3 存储桶中

DMARC 记录示例：
```
_dmarc.example.com. IN TXT "v=DMARC1; p=none; rua=mailto:dmarc-reports@example.com;"
```

## 回填报告

要处理 S3 存储桶中现有的 DMARC 报告：

```sh
go run ./backend/cmd/backfill/backfill.go
```

此命令将扫描您的 S3 存储桶中的 DMARC 报告，解析它们，并将数据存储在 PostgreSQL 数据库中。

## 前端设置

DMARC 分析器前端使用 Angular 构建。按照以下步骤设置和运行前端应用程序。

### 1. 前提条件

- Node.js 16 或更高版本
- Yarn 包管理器

### 2. 安装依赖

导航到前端目录并安装所需的依赖项：

```sh
cd frontend
yarn install
```

### 3. 开发服务器

启动开发服务器：

```sh
yarn start
```

默认情况下，这将在端口 4200 上启动 Angular 开发服务器。您可以通过 http://localhost:4200/ 访问应用程序。

### 4. 生产环境构建

要为生产环境构建应用程序：

```sh
yarn build
```

构建产物将存储在 `dist/` 目录中。

### 5. 运行测试

执行单元测试：

```sh
yarn test
```

运行端到端测试：

```sh
yarn e2e
```

### 6. 配置

前端应用程序配置为连接到在端口 6767 上运行的后端 API。如果需要更改此配置，请更新 `src/environments/` 中的环境文件。

## API 文档

DMARC 分析器提供以下 API 端点：

### 列出域名

```sh
curl http://127.0.0.1:6767/api/domains
```

返回所有具有 DMARC 报告的域名列表。

### 域名摘要报告

```sh
curl http://127.0.0.1:6767/api/domains/example.com/report?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回指定域名和日期范围的 DMARC 报告摘要。

### 域名详细报告

```sh
curl http://127.0.0.1:6767/api/domains/example.com/report/detail?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回指定域名和日期范围的详细 DMARC 报告信息。

### 域名 DMARC 图表数据

```sh
curl http://127.0.0.1:6767/api/domains/example.com/chart/dmarc?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回用于生成指定域名和日期范围的 DMARC 合规性图表的数据。

## 部署

### 使用预构建的 Docker 镜像

1. 从 GitHub Container Registry 拉取预构建的 Docker 镜像：

```sh
docker pull ghcr.io/dmarc-analyzer/dmarc-analyzer:latest
```

2. 创建一个包含以下内容的 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  dmarc-analyzer:
    image: ghcr.io/dmarc-analyzer/dmarc-analyzer:latest
    ports:
      - "6767:6767"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/dmarcdb
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - postgres

  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=dmarcdb
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backend/schema.sql:/docker-entrypoint-initdb.d/schema.sql

volumes:
  postgres-data:
```

3. 在项目根目录中的 `.env` 文件中配置环境变量。

4. 启动容器：

```sh
docker-compose up -d
```

这将在容器中启动 DMARC 分析器服务器和 PostgreSQL 数据库。

### 使用 Docker Compose 进行本地构建

1. 确保您的系统上安装了 Docker 和 Docker Compose。

2. 在 `docker-compose.yml` 文件中配置环境变量或在项目根目录中创建一个 `.env` 文件。

3. 构建并启动容器：

```sh
docker-compose up -d
```

这将在容器中启动 DMARC 分析器服务器和 PostgreSQL 数据库。

### 手动部署

1. 构建应用程序：

```sh
go build -o dmarc-server ./backend/cmd/server/server.go
```

2. 按照开发环境设置部分中的描述设置 PostgreSQL 数据库并应用架构。

3. 配置环境变量。

4. 运行服务器：

```sh
./dmarc-server
```

## 许可证

有关详细信息，请参阅 [LICENSE](LICENSE) 文件。