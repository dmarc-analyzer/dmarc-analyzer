# DMARC 分析器

DMARC 分析器是一个用于处理和分析 DMARC（基于域的消息认证、报告和一致性）报告的工具。它帮助组织监控电子邮件认证结果，保护其域名免受电子邮件欺骗和钓鱼攻击。

## 目录

- [概述](#概述)
- [前提条件](#前提条件)
- [环境变量](#环境变量)
- [开发环境设置](#开发环境设置)
- [AWS 服务配置](#aws-服务配置)
- [SQS 消息消费者](#sqs-消息消费者)
- [前端设置](#前端设置)
- [API 文档](#api-文档)
- [部署](#部署)

## 概述

DMARC 分析器处理存储在 S3 存储桶中的 DMARC 聚合报告。它解析这些报告，提取相关信息，并将数据存储在 PostgreSQL 数据库中以进行分析和可视化。系统支持手动处理和通过 SQS 消息队列的自动处理。

## 前提条件

- Go 1.24 或更高版本
- PostgreSQL 14 或更高版本
- 具有 S3 和 SQS 访问权限的 AWS 账户
- Docker 和 Docker Compose（用于容器化部署）

## 环境变量

应用程序需要以下环境变量：

```
# 数据库配置
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/dmarcdb

# AWS 配置
S3_BUCKET_NAME=your-dmarc-reports-bucket-name
SQS_QUEUE_URL=https://sqs.your-aws-region.amazonaws.com/your-aws-account-id/your-dmarc-reports-queue-name
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=your-aws-region
```

## 开发环境设置

### 1. 克隆仓库

```sh
git clone https://github.com/dmarc-analyzer/dmarc-analyzer.git
cd dmarc-analyzer
```

### 2. 设置数据库

```sh
# 创建 PostgreSQL 数据库
createdb dmarcdb

# 应用现有架构到您的数据库
psql -d dmarcdb -f backend/schema.sql
```

### 3. 重新生成数据库架构（高级）

此步骤仅在您修改了模型类并需要重新生成schema.sql文件时才需要执行。

```sh
# 生成新的数据库架构
dropdb --if-exists gen_sql && createdb gen_sql
go run ./backend/cmd/generate_sql.go
echo '-- Code generated by dmarc-analyzer generate_sql. DO NOT EDIT.' > backend/schema.sql
pg_dump -d gen_sql --schema-only --no-owner | sed '/^--/d' | sed '/^SET /d' | sed '/^SELECT /d' | sed 's/public\.//g' | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' -e 's/\n\n*/\n/' >> backend/schema.sql
dropdb --if-exists gen_sql

# 将新生成的架构应用到您的数据库
psql -d dmarcdb -f backend/schema.sql
```

### 4. 配置环境变量

在项目根目录中创建一个 `.env` 文件，其中包含上面列出的必需环境变量。

### 5. 运行应用程序

```sh
# 启动服务器
go run ./backend/cmd/server/server.go
```

服务器默认将在端口 6767 上启动。

## AWS 服务配置

### S3 存储桶设置

1. **创建一个 S3 存储桶来存储 DMARC 报告：**
   - 登录 AWS 管理控制台
   - 导航到 S3 服务
   - 点击"创建存储桶"
   - 输入唯一的存储桶名称（例如，`your-org-name-dmarc-reports`）
   - 选择您偏好的区域
   - 根据需要配置存储桶设置
   - 点击"创建存储桶"

2. **配置 S3 存储桶策略以允许 SES 写入：**
   创建存储桶后，您需要配置存储桶策略以允许 AWS SES 服务向存储桶写入电子邮件：
   
   - 转到您的 S3 存储桶 → 权限选项卡
   - 在存储桶策略部分点击"编辑"
   - 添加以下策略（将 `your-aws-account-id` 和 `your-dmarc-reports-bucket-name` 替换为您的实际值）：
   
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "AllowSESToWriteEmails",
         "Effect": "Allow",
         "Principal": {
           "Service": "ses.amazonaws.com"
         },
         "Action": [
           "s3:PutObject"
         ],
         "Resource": "arn:aws:s3:::your-dmarc-reports-bucket-name/*",
         "Condition": {
           "StringEquals": {
             "aws:SourceAccount": "your-aws-account-id"
           }
         }
       }
     ]
   }
   ```
   
   **重要：** 将以下占位符替换为您的实际值：
   - `your-aws-account-id`：您的 AWS 账户 ID
   - `your-dmarc-reports-bucket-name`：您的 DMARC 报告 S3 存储桶名称

3. **配置 IAM 权限：**
   - 创建具有以下权限的 IAM 用户或角色：
     ```json
     {
       "Version": "2012-10-17",
       "Statement": [
         {
           "Effect": "Allow",
           "Action": [
             "s3:GetObject",
             "s3:ListBucket",
             "s3:PutObject"
           ],
           "Resource": [
             "arn:aws:s3:::your-dmarc-reports-bucket-name",
             "arn:aws:s3:::your-dmarc-reports-bucket-name/*"
           ]
         }
       ]
     }
     ```

4. **获取 IAM 用户的 AWS 凭证**（访问密钥 ID 和秘密访问密钥）。

### SQS 队列设置

1. **创建 SQS 队列：**
   - 在 AWS 控制台中导航到 SQS 服务
   - 点击"创建队列"
   - 选择"标准队列"
   - 输入队列名称（例如，`dmarc-reports`）
   - 配置队列设置：
     - **可见性超时**：30 秒（推荐）
     - **消息保留期**：4 天（默认）
     - **接收消息等待时间**：20 秒（用于长轮询）
   - 点击"创建队列"

2. **配置 SQS 队列访问策略：**
   创建队列后，您需要配置访问策略以允许 AWS S3 服务向队列发送消息：
   
   - 转到您的 SQS 队列 → 权限选项卡
   - 在访问策略部分点击"编辑"
   - 用以下内容替换默认策略（将 `your-aws-account-id`、`your-aws-region` 和 `your-dmarc-reports-bucket-name` 替换为您的实际值）：
   
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": "arn:aws:iam::your-aws-account-id:root"
         },
         "Action": "SQS:*",
         "Resource": "arn:aws:sqs:your-aws-region:your-aws-account-id:your-dmarc-reports-queue-name"
       },
       {
         "Sid": "AllowS3ToSendMessages",
         "Effect": "Allow",
         "Principal": {
           "Service": "s3.amazonaws.com"
         },
         "Action": "sqs:SendMessage",
         "Resource": "arn:aws:sqs:your-aws-region:your-aws-account-id:your-dmarc-reports-queue-name",
         "Condition": {
           "StringEquals": {
             "aws:SourceAccount": "your-aws-account-id"
           }
         }
       }
     ]
   }
   ```
   
   **重要：** 将以下占位符替换为您的实际值：
   - `your-aws-account-id`：您的 AWS 账户 ID
   - `your-aws-region`：您的 AWS 区域（例如，us-east-1、eu-west-1）
   - `your-dmarc-reports-bucket-name`：您的 DMARC 报告 S3 存储桶名称（推荐格式：`your-org-name-dmarc-reports`）
   - `your-dmarc-reports-queue-name`：您的 SQS 队列名称（推荐格式：`dmarc-reports`）

3. **配置 SQS 的 IAM 权限：**
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "sqs:ReceiveMessage",
           "sqs:DeleteMessage",
           "sqs:GetQueueAttributes"
         ],
         "Resource": "arn:aws:sqs:your-aws-region:your-aws-account-id:your-dmarc-reports-queue-name"
       }
     ]
   }
   ```

### 设置电子邮件接收和 S3 事件触发器

**重要：** 仅支持 S3 传递方法进行 DMARC 报告处理。Lambda 函数无法访问电子邮件附件和正文内容，这些对于解析 DMARC 报告是必需的。

#### 使用 AWS SES（简单电子邮件服务）

1. **配置 SES 接收电子邮件：**
   - 在 AWS 控制台中导航到 SES 服务
   - 转到"电子邮件接收" → "规则集"
   - 创建新规则集或使用默认规则集
   - 创建新规则：
     - **收件人**：`dmarc-reports@yourdomain.com`
     - **操作**：存储在 S3 存储桶中
     - **S3 存储桶**：选择您的 DMARC 报告存储桶
     - **S3 键前缀**：`dmarc-reports/`（可选）

2. **配置 S3 事件通知：**
   - 转到您的 S3 存储桶 → 属性 → 事件通知
   - 点击"创建事件通知"
   - 配置事件：
     - **事件名称**：`dmarc-email-uploaded`
     - **事件类型**：选择"所有对象创建事件"
     - **目标**：SQS 队列
     - **SQS 队列**：选择您创建的 SQS 队列
   - 点击"保存更改"

**注意：** Lambda 函数不适合此用例，因为它们无法访问包含 DMARC 报告数据的电子邮件附件和正文内容。S3 传递方法保留了完整的电子邮件结构，允许 DMARC 分析器从电子邮件附件中提取和解析 XML 报告。

### DMARC 记录配置

要接收 DMARC 报告，请配置您域名的 DMARC 记录：

```
_dmarc.example.com. IN TXT "v=DMARC1; p=none; rua=mailto:dmarc-reports@example.com;"
```

确保 `rua` 字段中的电子邮件地址与 SES 中配置的收件人匹配。

## SQS 消息消费者

DMARC 分析器包含一个 SQS 消息消费者，可以自动处理新到达的 DMARC 报告。

### 构建和运行消费者

```sh
# 构建消费者
make build-consumer

# 运行消费者
make run-consumer

# 或者一步构建和运行
make run-consumer
```

### 手动构建和运行

```sh
# 构建
cd backend
go build -o ../bin/consumer ./cmd/consumer

# 运行
./bin/consumer
```

### 消费者功能

- **自动消息处理**：持续轮询 SQS 队列以获取新消息
- **重复检测**：防止处理同一电子邮件多次
- **错误处理**：具有重试逻辑的优雅错误处理
- **优雅关闭**：响应 SIGINT/SIGTERM 信号
- **详细日志记录**：用于监控和调试的综合日志记录

### 消费者的环境变量

```bash
# S3配置
export S3_BUCKET_NAME="your-dmarc-reports-bucket-name"

# SQS配置
export SQS_QUEUE_URL="https://sqs.your-aws-region.amazonaws.com/your-aws-account-id/your-dmarc-reports-queue-name"

# 数据库配置
export DB_HOST="localhost"
export DB_PORT="5432"
export DB_USER="your_db_user"
export DB_PASSWORD="your_db_password"
export DB_NAME="your_db_name"
export DB_SSLMODE="disable"
```

### 工作流程

1. **电子邮件接收**：DMARC 报告发送到您配置的电子邮件地址
2. **S3 存储**：SES 将电子邮件存储在您的 S3 存储桶中
3. **事件触发**：S3 事件通知向 SQS 发送消息
4. **消息处理**：消费者获取消息并处理电子邮件
5. **数据提取**：提取和解析 DMARC 报告数据
6. **数据库存储**：结果存储在 PostgreSQL 数据库中
7. **消息清理**：成功处理的消息从队列中删除

## 回填报告

要处理 S3 存储桶中现有的 DMARC 报告：

```sh
go run ./backend/cmd/backfill/backfill.go
```

此命令将扫描您的 S3 存储桶中的 DMARC 报告，解析它们，并将数据存储在 PostgreSQL 数据库中。

## 前端设置

DMARC 分析器前端使用 Angular 构建。按照以下步骤设置和运行前端应用程序。

### 1. 前提条件

- Node.js 16 或更高版本
- Yarn 包管理器

### 2. 安装依赖

导航到前端目录并安装所需的依赖项：

```sh
cd frontend
yarn install
```

### 3. 开发服务器

启动开发服务器：

```sh
yarn start
```

默认情况下，这将在端口 4200 上启动 Angular 开发服务器。您可以通过 http://localhost:4200/ 访问应用程序。

### 4. 生产环境构建

要为生产环境构建应用程序：

```sh
yarn build
```

构建产物将存储在 `dist/` 目录中。

### 5. 运行测试

执行单元测试：

```sh
yarn test
```

运行端到端测试：

```sh
yarn e2e
```

### 6. 配置

前端应用程序配置为连接到在端口 6767 上运行的后端 API。如果需要更改此配置，请更新 `src/environments/` 中的环境文件。

## API 文档

DMARC 分析器提供以下 API 端点：

### 列出域名

```sh
curl http://127.0.0.1:6767/api/domains
```

返回所有具有 DMARC 报告的域名列表。

### 域名摘要报告

```sh
curl http://127.0.0.1:6767/api/domains/example.com/report?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回指定域名和日期范围的 DMARC 报告摘要。

### 域名详细报告

```sh
curl http://127.0.0.1:6767/api/domains/example.com/report/detail?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回指定域名和日期范围的详细 DMARC 报告信息。

### 域名 DMARC 图表数据

```sh
curl http://127.0.0.1:6767/api/domains/example.com/chart/dmarc?start=2024-10-10T00:00:00Z&end=2024-10-20T00:00:00Z
```

返回用于生成指定域名和日期范围的 DMARC 合规性图表的数据。

## 部署

### 使用预构建的 Docker 镜像

1. 从 GitHub Container Registry 拉取预构建的 Docker 镜像：

```sh
docker pull ghcr.io/dmarc-analyzer/dmarc-analyzer:latest
```

2. 创建一个包含以下内容的 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  dmarc-analyzer:
    image: ghcr.io/dmarc-analyzer/dmarc-analyzer:latest
    ports:
      - "6767:6767"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/dmarcdb
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - postgres

  dmarc-consumer:
    image: ghcr.io/dmarc-analyzer/dmarc-analyzer:latest
    command: ./consumer
    environment:
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=dmarcdb
      - DB_SSLMODE=disable
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=dmarcdb
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backend/schema.sql:/docker-entrypoint-initdb.d/schema.sql

volumes:
  postgres-data:
```

3. 在项目根目录中的 `.env` 文件中配置环境变量：

```bash
# AWS 配置
S3_BUCKET_NAME=your-dmarc-reports-bucket-name
SQS_QUEUE_URL=https://sqs.your-aws-region.amazonaws.com/your-aws-account-id/your-dmarc-reports-queue-name
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=your-aws-region
```

4. 启动容器：

```sh
docker-compose up -d
```

这将在容器中启动 DMARC 分析器服务器、SQS 消费者和 PostgreSQL 数据库。

### 使用 Docker Compose 进行本地构建

1. 确保您的系统上安装了 Docker 和 Docker Compose。

2. 创建一个包含以下内容的 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  dmarc-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "6767:6767"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/dmarcdb
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - postgres

  dmarc-consumer:
    build:
      context: .
      dockerfile: Dockerfile
    command: ./consumer
    environment:
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=dmarcdb
      - DB_SSLMODE=disable
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=dmarcdb
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backend/schema.sql:/docker-entrypoint-initdb.d/schema.sql

volumes:
  postgres-data:
```

3. 在项目根目录中的 `.env` 文件中配置环境变量。

4. 构建并启动容器：

```sh
docker-compose up -d --build
```

### 手动部署

1. 构建应用程序和消费者：

```sh
# 构建主服务器
go build -o dmarc-server ./backend/cmd/server/server.go

# 构建 SQS 消费者
go build -o dmarc-consumer ./backend/cmd/consumer/consumer.go
```

2. 按照开发环境设置部分中的描述设置 PostgreSQL 数据库并应用架构。

3. 配置环境变量。

4. 运行服务器：

```sh
./dmarc-server
```

5. 在单独的终端中运行消费者：

```sh
./dmarc-consumer
```

## 许可证

有关详细信息，请参阅 [LICENSE](LICENSE) 文件。